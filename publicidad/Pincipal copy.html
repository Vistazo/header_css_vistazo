
<script type='text/javascript'>
    //Captura variables para DFP desde la url
    var getQueryString = function (field, url) {
        var href = url ? url : window.location.href;
        var reg = new RegExp('[?&]' + field + '=([^&#]*)', 'i');
        var string = reg.exec(href);
        return string ? string[1] : null;
    };
    dfp_demo = getQueryString("demo");
    var VI_Seccion = '${secPub}';
    var VI_Tipo = 'Portada';
    var VI_Subseccion = '';
    var VI_Articulo = '';
    var VI_Tag = '';
    // Detecta si la página está siendo cargada por un bot común o headless browser
    function isLikelyBot() {
        return /bot|crawl|slurp|spider/i.test(navigator.userAgent) || !('onscroll' in window) || /HeadlessChrome/.test(navigator.userAgent);
    }

    // Función para cargar scripts de manera condicional
    function loadScript(src, callback) {
        let script = document.createElement('script');
        script.src = src;
        script.async = true;
        script.onload = callback;
        document.head.appendChild(script);
    }

    // Carga scripts según el contexto de la página
    function loadExternalScripts() {
        if (!isLikelyBot()) {
            loadScript('https://a.teads.tv/analytics/tag.js', function() {
                console.log('Teads Analytics loaded');
                initializeTeadsAnalytics();
            });
            loadScript('https://www.googletagmanager.com/gtm.js?id=GTM-MJB87NX', function() {
                console.log('GTM loaded');
            });
            loadScript('https://securepubads.g.doubleclick.net/tag/js/gpt.js', function() {
                console.log('GPT loaded');
                initializeGPT();
            });
        }
    }



    // Inicializa Teads Analytics después de cargar el script
    function initializeTeadsAnalytics() {
        window.teads_analytics = window.teads_analytics || {};
        window.teads_analytics.analytics_tag_id = "PUB_18943";
        window.teads_analytics.share = window.teads_analytics.share || function () {
            (window.teads_analytics.shared_data = window.teads_analytics.shared_data || []).push(arguments);
        };
    }

    // Inicializa GPT y configura slots
    function initializeGPT() {
        window.googletag = window.googletag || {cmd: []};
        googletag.cmd.push(function() {
            var gptScriptLoaded = false;
            if (!gptScriptLoaded) {
                gptScriptLoaded = true;
                // Todo el código GPT que necesitas ejecutar
                const metaTags = document.getElementsByTagName('meta');
                let noAdsMetaTagFound = false;
                for (let i = 0; i < metaTags.length; i++) {
                    if (metaTags[i].getAttribute('name') === 'keywords' && metaTags[i].getAttribute('content') === 'no-ads') {
                        noAdsMetaTagFound = true;
                        break;
                    }
                }
                if (!noAdsMetaTagFound) {
                    initializeAdSlots();
                    displayAds();
                    console.log('Ads will be loaded because no "no-ads" meta tag was found.');
                } else {
                    console.log('No ads to load, "no-ads" meta tag found.');
                }
            }
            function initializeAdSlots() {
                // Aquí iría el resto del código para configurar y activar los anuncios
                window.googletag = window.googletag || { cmd: [] };
                googletag.cmd.push(function () {
                    //required variable for refresh
                    var REFRESH_KEY = "refresh";
                    var REFRESH_VALUE = "true";
                    var mappingbill = googletag.sizeMapping()
                        .addSize([992, 0], [[970, 250], [970, 180], [970, 90], [728, 250], [728, 180], [728, 90]]).addSize([768, 0], [[728, 250], [728, 180], [728, 90]]).addSize([320, 0], [[320, 100], [320, 50], [300, 100], [300, 50]]).addSize([0, 0], [[300, 100], [300, 250], [320, 100]]).build();
                    var mappingbox = googletag.sizeMapping()
                        .addSize([992, 0], [[300, 600], [300, 250]]).addSize([768, 0], [[300, 600], [300, 250]]).addSize([320, 0], [[300, 250], [320, 100], [320, 50], [300, 100], [300, 50]]).addSize([0, 0], [[300, 250], [300, 100], [300, 50]]).build();
                    var mappingcenter = googletag.sizeMapping()
                        .addSize([992, 0], [[728, 90], [728, 180], [728, 250]]).addSize([768, 0], [[728, 90], [728, 180], [728, 250]]).addSize([320, 0], [[320, 100], [300, 100], [300, 250]]).addSize([0, 0], [[320, 100], [300, 100], [300, 250]]).build();
                    var mappingHeader = googletag.sizeMapping()
                        .addSize([992, 0], [[728, 90], [970, 90]]).addSize([768, 0], [[728, 90]]).addSize([320, 0], [[320, 50]]).addSize([0, 0], [[320, 50]]).build();
        
                    //adUnits
                    googletag.defineSlot('/21839199781/Vistazo/Vistazo_Top1', [[300, 100], [300, 250], [320, 100], [728, 90], [970, 90], [970, 250]], 'Top1').defineSizeMapping(mappingbill).setTargeting(REFRESH_KEY, REFRESH_VALUE).addService(googletag.pubads());
                    googletag.defineSlot('/21839199781/Vistazo/Vistazo_Leader1', [[320, 100], [300, 100], [300, 250], [336, 280], [728, 90]], 'Leader1').defineSizeMapping(mappingcenter).setTargeting(REFRESH_KEY, REFRESH_VALUE).addService(googletag.pubads());
                    googletag.defineSlot('/21839199781/Vistazo/Vistazo_Center1', [[320, 100], [300, 100], [300, 250], [728, 90]], 'Center1').defineSizeMapping(mappingcenter).setTargeting(REFRESH_KEY, REFRESH_VALUE).addService(googletag.pubads());
                    googletag.defineSlot('/21839199781/Vistazo/Vistazo_Center2', [[320, 100], [300, 100], [300, 250], [728, 90]], 'Center2').defineSizeMapping(mappingcenter).setTargeting(REFRESH_KEY, REFRESH_VALUE).addService(googletag.pubads());
                    googletag.defineSlot('/21839199781/Vistazo/Vistazo_Center3', [[320, 100], [300, 100], [300, 250], [728, 90]], 'Center3').defineSizeMapping(mappingcenter).setTargeting(REFRESH_KEY, REFRESH_VALUE).addService(googletag.pubads());
                    //Reemplaza al Box de la home -------
                    googletag.defineSlot('/21839199781/Vistazo/Vistazo_Middle1', [[300, 600], [300, 250]], 'Middle1').defineSizeMapping(mappingbox).setTargeting(REFRESH_KEY, REFRESH_VALUE).addService(googletag.pubads());
                    //-----------------------------------
                    googletag.defineSlot('/21839199781/Vistazo/Vistazo_Middle2', [300, 250], 'Middle2').defineSizeMapping(mappingbox).setTargeting(REFRESH_KEY, REFRESH_VALUE).addService(googletag.pubads());
                    googletag.defineSlot('/21839199781/Vistazo/Floating', [1, 1], 'Floating').addService(googletag.pubads());
                    googletag.defineSlot('/21839199781/Vistazo/Zocalo', [1, 3], 'Zocalo').addService(googletag.pubads());
                    //Agregar este tag a la pagina
                    googletag.defineSlot('/21839199781/Vistazo/header', [[320, 50], [970, 90], [728, 90], [300, 50]], 'header_ad').defineSizeMapping(mappingHeader).addService(googletag.pubads());
                    googletag.pubads().enableLazyLoad({
                        fetchMarginPercent: 20,
                        renderMarginPercent: 10,
                        mobileScaling: 2.0,
                    });
                    //Start refresh
                    var SECONDS_TO_WAIT_AFTER_VIEWABILITY = 30; // 30 seconds
                    googletag.pubads().addEventListener("impressionViewable", function (event) {
                        var slot = event.slot;
                        if (slot.getTargeting(REFRESH_KEY).indexOf(REFRESH_VALUE) > -1) {
                            setTimeout(function () {
                                googletag.pubads().refresh([slot]);
                            }, SECONDS_TO_WAIT_AFTER_VIEWABILITY * 1000);
                        }
                    });
                    //End refresh
                    if (jQryIter.contextIsArticlePage()) {
                        VI_Tipo = 'Artículo';
                        VI_Subseccion = '${SectionName}';
                        var urltemp = window.location.href;
                        var n = urltemp.lastIndexOf("-");
                        VI_Articulo = urltemp.substring(n + 3);
                    }
                    // metadatos
                    $("meta[data-voc-name=topic]").each(function () {
                        if (VI_Tag == '') {
                            VI_Tag = $(this).attr('content');
                        }
                        else {
                            VI_Tag = VI_Tag + "," + $(this).attr('content');
                        }
                    });
        
                    parts = (window.location.href.split("/"));
                    console.log("parts", parts[3]);
        
                    if (parts[3] == 'hogar' && parts.length <= 4) {
                        VI_Seccion = 'Home-hogar';
                    }
                    if (parts[3].includes('taller-cocina-colada-morada-guaguas-pan')) {
        
                        VI_Seccion = 'formulariod4';
                    }
        
                    if (parts[4] && parts[4] != "") {
                        VI_Seccion = 'Home-hogar';
                        VI_Subseccion = parts[4] + '-hogar';
                    }
                    //console.log('VI_Seccion:' + VI_Seccion);
                    //console.log('VI_Subec:' + VI_Subseccion);
                    //console.log('VI_Tipo:' + VI_Tipo);
                    //console.log('VI_Articulo:' + VI_Articulo);
                    //console.log('VI_Tag:' + VI_Tag);
                    //console.log('dfp_demo:' + dfp_demo);
                    googletag.pubads().setTargeting('VI_Seccion', VI_Seccion);
                    googletag.pubads().setTargeting('VI_Subseccion', VI_Subseccion);
                    googletag.pubads().setTargeting('VI_Tipo', VI_Tipo);
                    googletag.pubads().setTargeting('VI_Articulo', VI_Articulo);
                    googletag.pubads().setTargeting('VI_Tag', VI_Tag);
                    //googletag.pubads().setTargeting('VI_Demo', dfp_demo);
                    googletag.pubads().setTargeting('censurado', 'no');
                    googletag.pubads().enableSingleRequest();
                    googletag.pubads().collapseEmptyDivs();
                    googletag.enableServices();
                });
              
                // inicio - Bottom_Anchor
                var interstitialSlot, bottomAnchorSlot;
                googletag.cmd.push(function () {
                    interstitialSlot = googletag.defineOutOfPageSlot("/21839199781/Vistazo_Web-ITT",googletag.enums.OutOfPageFormat.INTERSTITIAL);
                    interstitialSlot && interstitialSlot.addService(googletag.pubads());
                    bottomAnchorSlot = googletag.defineOutOfPageSlot("/21839199781/Vistazo_Bottom_Anchor",googletag.enums.OutOfPageFormat.BOTTOM_ANCHOR);
                    bottomAnchorSlot && bottomAnchorSlot.addService(googletag.pubads());
                });
                // fin - Bottom_Anchor
                googletag.cmd.push(function () {
                    interstitialSlot && googletag.display(interstitialSlot);
                    bottomAnchorSlot && googletag.display(bottomAnchorSlot);
                });
    
            }
    
            function displayAds() {
                // Verificamos que googletag y sus comandos estén definidos
                if (window.googletag && window.googletag.cmd) {
                    // Aseguramos que los comandos se ejecuten después de que GPT esté completamente cargado
                    googletag.cmd.push(function() {
                        // Ahora verificamos cada slot individualmente antes de intentar mostrarlo
                        if (document.getElementById('Top1') && googletag.pubads().getSlots().some(slot => slot.getSlotElementId() === 'Top1')) {
                            googletag.display('Top1');
                        }
                        if (document.getElementById('Leader1') && googletag.pubads().getSlots().some(slot => slot.getSlotElementId() === 'Leader1')) {
                            googletag.display('Leader1');
                        }
                        if (document.getElementById('Center1') && googletag.pubads().getSlots().some(slot => slot.getSlotElementId() === 'Center1')) {
                            googletag.display('Center1');
                        }
                        if (document.getElementById('Center2') && googletag.pubads().getSlots().some(slot => slot.getSlotElementId() === 'Center2')) {
                            googletag.display('Center2');
                        }
                        if (document.getElementById('Center3') && googletag.pubads().getSlots().some(slot => slot.getSlotElementId() === 'Center3')) {
                            googletag.display('Center3');
                        }
                        if (document.getElementById('Middle2') && googletag.pubads().getSlots().some(slot => slot.getSlotElementId() === 'Middle2')) {
                            googletag.display('Middle2');
                        }
                        if (document.getElementById('Middle1') && googletag.pubads().getSlots().some(slot => slot.getSlotElementId() === 'Middle1')) {
                            googletag.display('Middle1');
                        }
                        if (document.getElementById('header_ad') && googletag.pubads().getSlots().some(slot => slot.getSlotElementId() === 'header_ad')) {
                            googletag.display('header_ad');
                        }
                        if (document.getElementById('Floating') && googletag.pubads().getSlots().some(slot => slot.getSlotElementId() === 'Floating')) {
                            googletag.display('Floating');
                        }
                        if (document.getElementById('Zocalo') && googletag.pubads().getSlots().some(slot => slot.getSlotElementId() === 'Zocalo')) {
                            googletag.display('Zocalo');
                        }
                    });
                } else {
                    console.log("Google Tag Library not loaded");
                    setTimeout(displayAds, 2000);
                }
            }
        });
    } 

    //cargara despues despues de la primera interacion del usuario
    function handleFirstInteraction() {
        if (!isLikelyBot()) {
            loadExternalScripts();
            document.removeEventListener('click', handleFirstInteraction);
            document.removeEventListener('scroll', handleFirstInteraction);
        }
    }
    document.addEventListener('click', handleFirstInteraction, {passive: true});
    document.addEventListener('scroll', handleFirstInteraction, {passive: true});
    
</script>
